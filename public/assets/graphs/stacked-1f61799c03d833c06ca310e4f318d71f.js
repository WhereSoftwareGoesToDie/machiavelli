function getMetrics(e,t){flag=t,dataChart=new Array(e.length),$.each(e,function(e,t){feed=metricURL(gon.metrics[e].feed,gon.start,gon.stop,gon.step),$.getJSON(feed,function(r){return r.error?(renderError("chart",r.error),stopUpdates(),doneProgress(),!1):0===r.length?(renderError("chart",errorMessage.noData),stopUpdates(),doneProgress(),!1):(e=$.map(gon.metrics,function(e){return e.metric}).indexOf(t),dataChart[e]={data:r,name:t},void flagComplete())})})}function flagComplete(){complete++,updateProgress(),complete==metrics.length&&(doneProgress(),renderStacked(dataChart),unrenderWaiting())}function isRight(e){return right_id.indexOf(gon.metrics[e].id)>=0}function hasRight(){return 0!=clean(right_id,"").length}function isLeft(e){return 0==right_id.indexOf(gon.metrics[e].id)}function hasLeft(){return gon.metrics.length!=clean(right_id,"").length}function renderStacked(e){var t=new Rickshaw.Color.Palette({scheme:"munin"});for(colours=[],min=Number.MAX_VALUE,max=Number.MIN_VALUE,pad="line"==config.renderer?1:0,left_range=[min,max],right_range=[min,max],n=0;n<e.length;n++){for(min=Number.MAX_VALUE,max=Number.MIN_VALUE,i=0;i<e[n].data.length;i++)"number"==typeof e[n].data[i].y&&(min=Math.min(min,e[n].data[i].y),max=Math.max(max,e[n].data[i].y));isRight(n)?right_range=[Math.min(min,right_range[0])-pad,Math.max(max,right_range[1])+pad]:left_range=[Math.min(min,left_range[0])-pad,Math.max(max,left_range[1])+pad]}for(hasRight()&&(right_scale=d3.scale.linear().domain(right_range)),hasLeft()&&(left_scale=d3.scale.linear().domain(left_range)),series=[],n=0;n<e.length;n++)colours[n]=t.color(),scale=isRight(n)?right_scale:left_scale,series.push({color:colours[n],data:e[n].data,name:e[n].name,scale:scale});config.interpolate="monotone","xkcd"==flag&&(config.interpolate="xkcd"),graph=new Rickshaw.Graph({element:document.querySelector("#chart"),width:700,height:300,series:series}),graph.configure(config),hasLeft()&&(left_axis=new Rickshaw.Graph.Axis.Y.Scaled({element:document.getElementById("y_axis"),graph:graph,orientation:"left",tickFormat:Rickshaw.Fixtures.Number.formatKMBT_round,scale:left_scale})),hasRight()&&(right_axis=new Rickshaw.Graph.Axis.Y.Scaled({element:document.getElementById("y_axis_right"),graph:graph,grid:!1,orientation:"right",tickFormat:Rickshaw.Fixtures.Number.formatKMBT_round,scale:right_scale})),new Rickshaw.Graph.Axis.Time({graph:graph,timeFixture:getTimeFixture()}),dynamicWidth(graph),graph.render(),config.stack===!1&&"area"==config.renderer&&$(document.head).append("<style>path.area{opacity:0.8};.legend-color{opacity:0.8}</style>"),slider=new Rickshaw.Graph.RangeSlider.Preview({graph:graph,height:30,element:$("#slider")[0],onChangeDo:generate_legend});new Rickshaw.Graph.HoverDetail({graph:graph,formatter:function(e,t,r,a,n,i){var o='<span class="detail_swatch" style="background-color: '+e.color+'"></span>',s='<span class="date"> '+getD3Time(t)+"</span>",l=o+format_metrics[i.order-1]+": "+r.toFixed(4)+"<br>"+s;return l},xFormatter:function(e){return new Date(1e3*e).toString()}});generate_legend()}function generate_legend(){function e(e){r={avg:0,min:0,max:0,std:0},t=e.length,r.max=Math.max.apply(Math,e),r.min=Math.min.apply(Math,e);for(var a,n=0,i=t;i--;n+=e[i]);for(a=r.mean=n/t,i=t,n=0;i--;n+=Math.pow(e[i]-a,2));return r.deviation=Math.sqrt(r.variance=n/t),r}function a(e){return Rickshaw.Fixtures.Number.formatKMBT_round(e)}function n(e){return min=void 0===graph.window.xMin?Number.MIN_VALUE:graph.window.xMin,max=void 0===graph.window.xMax?Number.MAX_VALUE:graph.window.xMax,$.map(e,function(e){return e.x>=min&&e.x<=max?e.y:void 0})}function i(e){return c=[],["&nbsp","average","deviation","bounds"].forEach(function(e){c.push("<td align='right'>"+e+"</td>")}),c.splice(1,0,"<td>"+e+" Axis</td>"),c.join("")}var o=document.querySelector("#legend-dual");left=[],right=[];for(var l=0;l<graph.series.length;l++)d=graph.series[l],obj={},obj.metric=format_metrics[l],obj.colour=d.color,obj.ydata=n(d.data),obj.sourceURL=gon.metrics[l].sourceURL,obj.index=l,obj.div_name="metric_"+l+"_url",isRight(l)?(obj.link=left_links[l],obj.tooltip="Move metric to the left y-axis",right.push(obj)):(obj.link=right_links[l],obj.tooltip="Move metric to the right y-axis",left.push(obj));arr=[],len=Math.max(left.length,right.length);for(var h=0;len>h;h++)arr.push([left[h],right[h]]);showURLs=[],table=["<table class='table table-condensed borderless' width='100%'>"],emptyHeader="<td colspan=5>&nbsp;</td>",header="",header+=arr[0][0]?i("Left"):emptyHeader,header+=arr[0][1]?i("Right"):emptyHeader,table.push(header),config.stack&&(arr=arr.reverse()),arr.forEach(function(t){function r(e,t){return s="<td class='table_detail' align='right' data-toggle='tooltip-shuffle' nowrap ",s+="data-original-title='"+t+"'>"+e+"</td>"}table.push("<tr>"),t.forEach(function(t){"object"==typeof t?(y=e(t.ydata),el=["<td class='legend-color' style='width: 10px; background-color: "+t.colour+"'>&nbsp</td>"],el.push("<td class='legend-metric'><a href='"+t.link+"' data-toggle='tooltip-shuffle' data-original-title='"+t.tooltip+"'>"+t.metric+"</a> <div id='"+t.div_name+"' class='metric_url' style='display:inline'></div></td>"),el.push(r(a(y.mean),y.mean)),el.push(r(a(y.deviation),y.deviation)),el.push(r(a(y.min)+", "+a(y.max),y.min+" - "+y.max)),table.push(el.join("")),showURLs.push([t.div_name,t.sourceURL])):table.push("<td colspan=5>&nbsp;</td>")}),table.push("</tr>")}),hasRight()?table.push("<tr><td colspan=12><a href='"+reset+"'>Reset Left/Right Axis</a></td></tr>"):graph.series.length>=2&&table.push("<tr><td colspan=12>Click a metric to move it to the Right Axis</td></tr>"),table.push("<table>"),o.innerHTML=table.join("\n"),showURLs.forEach(function(e){showURL(e[0],e[1])}),$("[data-toggle='tooltip-shuffle']").tooltip({placement:"bottom",container:"body",delay:{show:500}})}function updateStacked(){return intervalID=setInterval(function(){now=parseInt(Date.now()/1e3),span=gon.stop-gon.start,$.each(gon.metrics,function(e,t){t.live&&(update=metricURL(t.feed,now-span,now,gon.step),$.getJSON(update,function(t){return t.error?(renderError("flash",t.error),stopUpdates(),!1):0===t.length?(renderError("flash",errorMessage.noData),stopUpdates(),!1):(graph.series[e].data=t,void graph.render())}))})},1e3*gon.step)}var dataChart=[],flag,complete=0;initProgress();var slider;